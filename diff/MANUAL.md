# 로그 비교 GUI 사용 설명서

## 📦 설치

```bash
pip install diff-match-patch scikit-learn
python log_compare_improved.py
```

---

## 🎯 기본 사용법

### 1. 폴더 선택
- **원본 폴더**: 비교 기준 폴더
- **비교대상 폴더**: 비교할 대상 폴더  
- **출력 폴더**: 결과 저장 위치 (기본: 비교대상/LLD_diff)

### 2. 옵션 설정

| 옵션 | 설명 |
|------|------|
| 라인 trim | 앞뒤 공백 제거 후 비교 |
| 공백 무시 | 연속된 공백을 1개로 정규화 (들여쓰기 차이 무시) |
| 대소문자 무시 | 대문자/소문자 구분 안 함 |
| 블록 모드 | `#` 주석 단위로 블록 분리 후 비교 (권장) |
| 파일 필터 | `*.log`, `*.yaml` 등 (직접 입력 가능) |

---

## 🔧 파라미터 설정

### 블록 매칭 임계값 (0.30 ~ 0.70)
두 블록이 같은 것으로 판단하는 유사도 기준

- **0.30**: 낮음 (다소 다른 블록도 매칭) → 감지 많음
- **0.70**: 높음 (매우 유사한 블록만 매칭) → 감지 적음
- **기본값: 0.45**

### 가중치 설정 (4개)

| 가중치 | 설명 | 기본값 |
|--------|------|--------|
| 블록 키 | 이름이 같은가? | 0.25 |
| YAML 서명 | apiVersion/kind이 같은가? | 0.25 |
| YAML 키 | 구조가 같은가? | 0.20 |
| TF-IDF | 내용(본문)이 같은가? | 0.30 |

**주의**: 
- 슬라이더로 설정한 값이 그대로 표시됨
- "가중치 자동 정규화" ON이면, 실행 시 합이 1.00이 되도록 자동 보정

---

## ✨ 3대 개선 기능

### 1️⃣ 가중치 자동 정규화
```
☑ 가중치 자동 정규화(실행 시 합=1.00으로 보정)
```

**기능**:
- 슬라이더로 0.25 + 0.25 + 0.20 + 0.25 = 0.95 로 설정해도
- 실행 시 합이 1.00이 되도록 자동 스케일링
- 슬라이더 값은 그대로 유지 (표시는 변경 안 함)
- 로그에 "가중치(실행 적용값)" 으로 실제 사용된 값 표시

**언제 사용?**
- 정확한 비율이 중요한 경우
- 합이 정확히 1.00일 필요가 없을 때

---

### 2️⃣ TF-IDF 예외 로그 (디버그 모드)
```
☑ 디버그 로그(TF-IDF 예외/폴백 메시지 출력)
```

**출력 메시지**:

| 메시지 | 의미 |
|--------|------|
| `[TFIDF_ERROR]` | TF-IDF 벡터화 실패 (디버그 ON일 때만) |
| `[FALLBACK]` | diff-match-patch 실패 → difflib로 자동 전환 |
| `[READ_FAIL]` | 파일 읽기/인코딩 오류 |

**예시**:
```
[FALLBACK] diff-match-patch 사용 불가 → difflib fallback 적용: ValueError: Too many unique lines
[TFIDF_ERROR] "pod-creation" vs "pod-status" | Exception: Invalid input
```

**제한**:
- TF-IDF 에러는 최대 50개까지만 로그 (과다 방지)
- FALLBACK/READ_FAIL은 항상 출력

**언제 사용?**
- 성능 이상 원인 파악
- 대용량 파일 처리 확인

---

### 3️⃣ Fallback 메커니즘 (자동)

**상황별 대응**:

| 상황 | 원래 방식 | Fallback |
|------|---------|---------|
| 정상 | diff-match-patch | - |
| 라인 많음 (>0x10FFFF) | ❌ ValueError | ✓ difflib opcode |
| diff-match-patch 예외 | ❌ 실패 | ✓ difflib opcode |

**효과**:
- 매우 큰 파일도 처리 가능
- 에러 없이 비교 계속 진행
- 일반 diff 레벨이지만 여전히 정확한 결과

---

## 📋 실행 파라미터 표시

비교 시작 시 로그에 출력되는 정보:

```
【 현재 설정 파라미터 】
===============================================================================
임계값:              0.45 (블록이 이 이상 유사해야 매칭)

가중치(슬라이더 값):
  • 블록 키:        0.25
  • YAML 서명:      0.25
  • YAML 키 구조:   0.20
  • TF-IDF (본문):  0.30
  ─────────────────────
  합계:             1.00 ✓

자동 정규화:         ON
디버그 로그:         ON

가중치(실행 적용값):        ← 자동 정규화 적용 후 값
  • 블록 키:        0.2632
  • YAML 서명:      0.2632
  • YAML 키 구조:   0.2105
  • TF-IDF (본문):  0.1632
  ─────────────────────
  합계:             1.0000
===============================================================================
```

---

## 🚫 예외처리 필드 (자동 제외)

| 필드 | 이유 |
|------|------|
| `uid` | 시스템 생성, 매번 다름 |
| `creationTimestamp` | 생성 시간, 환경마다 다름 |
| `generation` | 스펙 변경 횟수, 환경마다 다름 |
| `lastTransitionTime` | 마지막 상태 변경 시간, 실행마다 다름 |
| `lastResync` | 재동기화 시간, 주기적 업데이트 |
| `observedGeneration` | 컨트롤러 관찰 정보, 환경마다 다름 |
| `managedFields` | 필드 관리 메타데이터, 매우 복잡 |

**주의**: Bearer Token은 **비교 대상에 포함**됩니다 (보안 확인용)

---

## 📊 결과 해석

### 요약 정보

```
✓ 매칭: 123 | 동일: 100 (81%) | 변경: 23 | 누락-원본: 5 | 누락-비교: 3 | 시간: 12.5초
```

| 항목 | 의미 |
|------|------|
| 매칭 | 원본과 비교대상에 모두 있는 파일 수 |
| 동일 | 내용이 같은 파일 |
| 변경 | 내용이 다른 파일 (리포트 생성) |
| 누락-원본 | 원본에만 있는 파일 |
| 누락-비교 | 비교대상에만 있는 파일 |

### 리포트 파일 (LLD_diff/파일명.txt)

```
Path: config.yaml
Status: changed
Summary:
  Hunks: 3              (변경된 블록 수)
  InsertedLines: 5      (추가된 라인)
  DeletedLines: 2       (삭제된 라인)
  ReplacedLines: 1      (변경된 라인)
  Similarity: 85%       (전체 유사도)

HUNK 1
  Block: pod-creation
  SourceRange: 10-15 (원본 라인)
  TargetRange: 10-18 (비교 라인)
  Type: replace
  SourceYAML: Pod/my-pod
  SourcePreview: (원본 미리보기)
  TargetPreview: (변경본 미리보기)
```

---

## 🔍 블록 모드 vs 일반 모드

### 블록 모드 (권장)
```
# pod-creation
metadata:
  name: my-pod
---
# pod-status
status:
  phase: Running
```
→ `#` 단위로 블록 분리 → 블록 정렬 → 각 블록 내부에서 diff

**장점**: 순서 변경 감지 안 함, 구조 비교 정확

### 일반 모드
→ 전체 파일을 한 번에 비교

**장점**: 빠름 / **단점**: 라인 순서 변경에 민감

---

## 💾 Token 비교 (보안)

**Bearer Token은 비교 대상에 포함됩니다**

| 상황 | 결과 |
|------|------|
| Token 같음 | 동일 ✓ |
| Token 다름 | **변경됨** (차이 감지) |

**주의사항:**
- 리포트에 Token이 그대로 표시됨
- LLD_diff 폴더 접근 권한 관리 필수
- 민감한 정보 주의 필요

---

## ⚙️ 고급 설정

### 메모리 최적화
- **TF-IDF 샘플링**: 처음 50KB만 분석 (메모리 절약)
- **유니코드 Fallback**: 라인 수 초과 시 자동으로 difflib 사용

### 큐 관리
- **최대 메시지**: 1000개 (오버플로우 방지)
- **Progress 드롭**: 큐가 꽉 차면 진행 상황은 드롭 가능
- **Done/Error**: 필수 메시지는 보장

---

## 🐛 트러블슈팅

### 라이브러리 설치 실패
```bash
pip install --upgrade pip
pip install diff-match-patch scikit-learn --user
```

### tkinter 없음 (Linux)
```bash
sudo apt-get install python3-tk
```

### "[FALLBACK]" 메시지가 자주 나옴
- **원인**: 파일이 매우 크거나 라인이 많음
- **해결**: 정상 동작 (자동으로 difflib로 전환)
- **확인**: 리포트 결과가 올바른지 검증

### 비교 시간이 오래 걸림
- 블록 모드 활성화
- 파일 필터로 필요한 파일만 비교
- 임계값을 높임 (0.6 이상)
- 디버그 모드 OFF

### 메모리 부족
- MAX_SAMPLE_SIZE를 줄임 (코드 수정)
- 비교 파일 수 감소

---

## 📝 예제

### Kubernetes 매니페스트 비교

```
옵션:
  - 블록 모드: ✓ (활성화)
  - 라인 trim: ✓
  - 공백 무시: ✓

파라미터:
  - 임계값: 0.45
  - YAML 서명 가중치: 0.35 (높임)
  - TF-IDF 가중치: 0.25 (낮춤)
  - 가중치 자동 정규화: ✓ ON
```

### 로그 파일 비교

```
옵션:
  - 블록 모드: ✓ (활성화)
  - 대소문자 무시: ✓

파라미터:
  - 임계값: 0.50
  - TF-IDF 가중치: 0.40 (높임)
  - 블록 키 가중치: 0.15 (낮춤)
  - 디버그 로그: ✓ ON (문제 있을 시)
```

---

## 📊 성능 정보

| 상황 | 처리 시간 |
|------|---------|
| 작은 파일 (< 1MB) | < 1초 |
| 중간 파일 (1-10MB) | 1-10초 |
| 큰 파일 (10-100MB) | 10-60초 |
| 1000개 파일 | 1-5분 |

**최적화 효과:**
- 샘플링으로 메모리 50배 절약
- Fallback으로 대용량 파일도 처리 가능
- 선택적 큐 드롭으로 UI 응답성 유지

---

## ✅ 체크리스트

**시작 전:**
- [ ] Python 3.7+ 설치
- [ ] 필요 라이브러리 설치
- [ ] 비교할 폴더 준비

**사용 중:**
- [ ] 폴더 3개 선택
- [ ] 옵션 설정
- [ ] 파라미터 조정
- [ ] 자동 정규화/디버그 옵션 선택
- [ ] "비교 시작" 클릭

**결과 확인:**
- [ ] 팝업 메시지 확인
- [ ] 요약 정보 검토
- [ ] LLD_diff 리포트 확인
- [ ] 필요시 로그에서 에러 확인

**보안:**
- [ ] Token 포함된 리포트 폴더 권한 관리
- [ ] 민감한 정보 공유 정책 검토

---

## 📞 주요 파일

| 파일 | 설명 |
|------|------|
| `log_compare_improved.py` | 실행 파일 |
| `LLD_diff/` | 비교 결과 폴더 |
| `LLD_diff/파일명.txt` | 상세 리포트 |

---

**버전**: 1.3 (3대 개선 적용) | **마지막 수정**: 2026-01-29

